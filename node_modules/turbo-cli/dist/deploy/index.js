var Promise=require("bluebird"),shell=require("shelljs"),readdirp=require("readdirp"),base64=require("js-base64"),awsClient=require("../aws"),utils=require("../utils"),path=require("path"),dotenv=require("dotenv"),bestzip=require("bestzip"),BASE_URL="https://www.turbo360.co",zipDirectory=function(){return process.platform,bestzip.nodeZip({source:"*",destination:"../package.zip"})},prepareDirectory=function(e){shell.mkdir("-p",".deploy/"),e.forEach(function(e,n){-1==e.indexOf(".")?(shell.mkdir("-p",".deploy/"+e+"/"),shell.cp("-R",e+"/*",".deploy/"+e+"/")):shell.cp("-R",e,".deploy/"+e)})},configureUploader=function(e,n){return awsClient.s3sync(null,e).on("data",function(e){shell.echo("-n",".")}).once("end",n)},deployComplete=function(e,n,o){awsClient.invalidateCache(o.split("::")[2],e.slug),utils.readFile("package.json").then(function(o){json=JSON.parse(o);var t={environment:n,site:{id:e.id,name:e.name,image:e.image,slug:e.slug,format:json.format||"vertex"}};return utils.postRequest("https://production.turbo360-vector.com/turbo-bohpvv/deployComplete",t)}).then(function(e){}).catch(function(e){})},compile=function(e,n,o,t){return new Promise(function(e,n){var o=null,l={};utils.readFile("package.json").then(function(e){return o=JSON.parse(e),utils.readFile(".env")}).then(function(e){if(l=dotenv.parse(e),null==l.SESSION_SECRET)throw new Error("Please include a SESSION_SECRET environment variable in the .env file.");l.TURBO_ENV="prod";var n=(Object.keys(o.dependencies),Object.assign({},o.devDependencies));return delete o.devDependencies,shell.mkdir("-p",t+"/"),shell.cp("-R","!(node_modules|deploy)",t+"/"),utils.write("./"+t+"/package.json",JSON.stringify(o,null,2)+"\n"),shell.cd(t),shell.mkdir("-p","www"),shell.cp("-R",path.join(__dirname,"../default/vertex/www/bin.js"),"www/bin.js"),shell.exec("npm install --silent --no-progress"),shell.cd(".."),o.devDependencies=n,utils.write("./"+t+"/package.json",JSON.stringify(o,null,2)+"\n"),shell.cd(t),zipDirectory()}).then(function(){shell.cd(".."),shell.mv(["package.zip"],t+"/"),shell.cd(t),shell.rm("-rf","node_modules"),shell.rm("-rf","www"),e(l)}).catch(function(e){console.log("COMPILE ERROR: "+e.message),n(e)})})};module.exports={deployToStaging:function(e,n,o,t){prepareDirectory(o);var l=function(){shell.rm("-rf",".deploy");var n="https://"+t.slug+".turbo360-dev.com";console.log("\nDEPLOY COMPLETE: "+n+"\n"),console.log("1. Changes take effect after a couple minutes while we update all servers. Please wait a few moments to view live changes.\n"),console.log("2. If changes are not visible after a few minutes, try hard-reloading the page.\nSee here for instructions: https://superuser.com/questions/721692/google-chrome-clear-cache-for-specific-website\n"),deployComplete(t,"staging",e)},r=configureUploader({key:e.split("::")[0],secret:e.split("::")[1],bucket:n,concurrency:16,prefix:t.slug+"/"},l);readdirp({root:".deploy"}).pipe(r)},deployToProduction:function(e,n,o,t){prepareDirectory(o);var l=function(){shell.rm("-rf",".deploy");var n="https://"+t.slug+".turbo360-prod.com";console.log("\nDEPLOY COMPLETE: "+n+"\n"),console.log("IMPORTANT: Add a CNAME record on your DNS provider and point it to: "+t.slug+".turbo360-prod.com. This URL will NOT work on its own.\n"),console.log("1. Changes take effect after a couple minutes while we update all servers. Please wait a few moments to view live changes.\n"),console.log("2. If changes are not visible after a few minutes, try hard-reloading the page.\nSee here for instructions: https://superuser.com/questions/721692/google-chrome-clear-cache-for-specific-website\n"),deployComplete(t,"production",e)},r=configureUploader({key:e.split("::")[0],secret:e.split("::")[1],bucket:n,concurrency:16,prefix:t.url+"/"},l);readdirp({root:".deploy"}).pipe(r)},build:function(e,n,o){console.log("\n\nGenerating package.zip file...\n"),compile(e,n,o,".deploy").then(function(e){shell.mv(["package.zip"],".."),shell.cd(".."),shell.rm("-rf",".deploy"),console.log("\n\n* * * Build complete. Check current directory for package.zip file. * * *\n\n")}).catch(function(e){console.log("ERROR: "+e.message)})},deployToVertex:function(e,n,o){var t=o.slug+"/",l={};console.log("\n\nDeploying to Turbo Staging Environment...\n"),compile(e,n,o,".deploy").then(function(r){l=r,shell.cd("..");var i=function(){shell.rm("-rf",".deploy");var r=t.split("/")[0],i={config:e,name:r,path:r+"/package.zip",env:l};awsClient.getFunction(i).then(function(e){return null==e?null:awsClient.deleteFunction(i)}).then(function(o){return awsClient.deleteObject({Bucket:n,Key:r+"/"},e)}).then(function(e){return awsClient.deployVertex(i)}).then(function(n){var t="vertex360"==o.origin?".vertex360.co":".turbo360-vertex.com";"vertex360"==o.origin&&utils.postRequest("https://vertex360.herokuapp.com/admin/seed",{app:o.slug}).then(function(e){}).catch(function(e){}),console.log("\n\nDEPLOY COMPLETE\nStaging URL: https://"+i.name+t+"\n"),deployComplete(o,"production",e)}).catch(function(e){console.log("ERROR: "+e.message)})},c=e.split("::"),s=configureUploader({key:c[0],secret:c[1],bucket:n,concurrency:16,prefix:t},i);readdirp({root:".deploy"}).pipe(s)}).catch(function(e){console.log(e.message)})},deployToCustom:function(e,n,o){var t=o.slug+"/",l={};console.log("\n\nDeploying to Turbo Staging Environment...\n"),compile(e,n,o,".deploy").then(function(r){l=r,shell.cd("..");var i=function(){shell.rm("-rf",".deploy");var r=t.split("/")[0],i={config:e,name:r,path:r+"/package.zip",env:l,bucket:n,role:o.role};awsClient.getFunction(i).then(function(e){return null==e?null:awsClient.deleteFunction(i)}).then(function(o){return awsClient.deleteObject({Bucket:n,Key:r+"/"},e)}).then(function(e){return awsClient.deployVertex(i)}).then(function(e){console.log('\n* * *\nDEPLOY COMPLETE.\nYour app has been uploaded to the specified S3 bucket (folder name: "'+r+'") and a corresponding Lambda function with the same name has been created to run it.\nNEXT STEPS: Create an API via API Gateway and connect it to the Lambda function.\n* * *\n')}).catch(function(e){console.log("ERROR: "+e.message)})},c=e.split("::"),s=configureUploader({key:c[0],secret:c[1],bucket:n,concurrency:16,prefix:t},i);readdirp({root:".deploy"}).pipe(s)}).catch(function(e){console.log(e.message)})}};