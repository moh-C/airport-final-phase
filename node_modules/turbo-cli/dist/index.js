#!/usr/bin/env node
var program=require("commander"),shell=require("shelljs"),path=require("path"),fs=require("fs"),os=require("os"),readdirp=require("readdirp"),theme=require("./theme"),scaffold=require("./scaffold"),extend=require("./extend"),utils=require("./utils"),awsClient=require("./aws"),auth=require("./auth"),template=require("./template"),vectors=require("./vectors"),deploy=require("./deploy"),base=require("./base"),dotenv=require("dotenv"),BASE_URL="https://turbo-dashboard.herokuapp.com",VERTEX_BASE_URL="https://vertex360.herokuapp.com",PLATFORM_VECTOR_URL="https://platform.turbo360-vector.com";program.arguments("<action> <arg>").option("-e, --express","with express").option("-s, --static","static site").option("-r, --react","react/redux app").option("-gql, --graphql","graphql app").option("-v, --vertex","vertex project").option("-vc, --vector","vectors app").option("-i, --app_id <app_id>","APP Id").action(function(e,n){if("theme"==e)return void theme.configureTheme(n)}),program.command("new <name>").description("create new Turbo 360 project").action(function(e){shell.mkdir("-p",e),shell.cd(e),program.express?scaffold(shell,e,"fullstack"):program.react?scaffold(shell,e,"react"):program.graphql?scaffold(shell,e,"graphql"):(program.vertex,scaffold(shell,e,"vertex"))}),program.command("app <appId>").description("connect app to staging environment").action(function(e){if(0==auth.isLoggedIn())return console.log("\nPlease Log In to Connect Site:"),void console.log("$ turbo login\n");var n=null,o=null,t=null;auth.currentUser().then(function(n){return t=n,utils.getRequest(BASE_URL+"/api/site/"+e)}).then(function(r){if("success"!=r.confirmation)throw new Error(r.message);if(0==auth.isAuthorized(r.result,t))throw new Error("\nYou must be the admin or a collaborator for this project. To login:\n$ turbo login\n");return o=r.result,n={siteId:e,apiKey:o.api.key},utils.readFile(".env","\n\n.env file not found. Please add .env file.\n\n")}).then(function(e){var t=dotenv.parse(e);t.TURBO_APP_ID=n.siteId,t.TURBO_API_KEY=n.apiKey,t.TURBO_APP_SLUG=o.slug,t.TURBO_CDN="https://cdn.turbo360-vertex.com/"+o.slug+"/public",t.TMP_DIR="/tmp",null==t.SESSION_SECRET&&(t.SESSION_SECRET="YOUR_SESSION_SECRET"),null==t.TURBO_ENV&&(t.TURBO_ENV="dev");var r="";return Object.keys(t).forEach(function(e,n){r+=e+"="+t[e]+"\n"}),utils.write(".env",r),console.log("\n\nApp credentials successfully configured.\n\n"),e}).catch(function(e){console.log("Error:"+e.message)})}),program.command("base <name>").description("install Turbo 360 base project").action(function(e){base.installBase(e).then(function(n){shell.echo('Base "'+e+'" implemented.')}).catch(function(e){shell.echo("Error: "+e.message)})}),program.command("extend <format>").description("extend Turbo 360 project").action(function(e){console.log("Extending project..."),extend(shell,e).then(function(n){const o=null==n.message?"Project successfully extended: "+e:n.message;shell.echo(o)}).catch(function(e){shell.echo("Error: "+e.message)})}),program.command("template <format>").description("Create Vertex 360 template").action(function(e){if(null==template[e])return console.log("\nInvalid Template. Please Select From the following: "),console.log(Object.keys(template).join("\n")),void console.log("\n");var n=utils.isTurboApp();if(1==n.isTurboApp)return void scaffold(shell,e,"template",null);if("package.json"!=n.missing)return void console.log("\nInvalid Turbo 360 app: "+n.reason+"\n");if(0==auth.isLoggedIn())return console.log("\nPlease Log In to Add Page:"),void console.log("$ turbo login\n");console.log("Creating template...");var o=null,t=null,r=null;auth.currentUser().then(function(e){return r=e,auth.connectApp()}).then(function(e){if(t=e,0==e.siteId.length)throw new Error("App Id required");if(0==e.apiKey.length)throw new Error("API Key required");return utils.getRequest(BASE_URL+"/api/site/"+e.siteId)}).then(function(n){if(o=n.result,0==auth.isAuthorized(o,r))throw new Error("\nYou must be the admin or a collaborator for this project. To login:\n$ turbo login\n");return t.slug=o.slug,utils.postRequest(PLATFORM_VECTOR_URL+"/seedtemplate",{source:e,app:o.slug})}).then(function(n){var t={category:e,status:"dev"};return utils.putRequest(VERTEX_BASE_URL+"/api/site/"+o.id,{origin:"vertex360",template:t})}).then(function(n){shell.mkdir("-p",t.slug),shell.cd(t.slug),scaffold(shell,e,"template",t)}).catch(function(e){console.log("Error: "+e.message)})}),program.command("resource <name>").description("Add resource").action(function(e){extend(shell,"resource",{name:e}).then(function(e){shell.echo(e.message)}).catch(function(e){shell.echo("Error: "+e.message)})}),program.command("page <name>").description("Upload page").action(function(e){var n=null,o=null,t=null;if(0==auth.isLoggedIn())return console.log("\nPlease Log In to Add Page:"),void console.log("$ turbo login\n");auth.currentUser().then(function(e){return n=e,utils.readFile(".env")}).then(function(e){o=dotenv.parse(e);var n=o.TURBO_APP_ID;if(null==n)throw new Error('Missing App ID. Please add to .env file under "TURBO_APP_ID" key.');if(n.length<20)throw new Error('Please specify Turbo App ID in the .env file under "TURBO_APP_ID" key.');return utils.getRequest(BASE_URL+"/api/site/"+n)}).then(function(o){if(t=o.result,0==auth.isAuthorized(t,n))throw new Error("\nYou must be the admin or a collaborator to deploy this project. To login:\n$ turbo login\n");return shell.cd("pages"),utils.readFile(e+".json")}).then(function(n){if(shell.cd(".."),"global"==e)return utils.putRequest(VERTEX_BASE_URL+"/api/site/"+t.id,{globalConfig:n});var o=JSON.stringify(n);return utils.postRequest(PLATFORM_VECTOR_URL+"/pageconfig",{app:t.slug,page:e,config:o})}).then(function(n){if("global"==e)return null;var o=BASE_URL+"/admin/resetpage";return utils.postRequest(o,{page:e,appslug:t.slug})}).then(function(n){if("global"==e)return null;var o=e.trim().toLowerCase();if(-1!=t.pages.indexOf(o))return null;var r=Object.assign([],t.pages);return r.push(o),utils.putRequest(VERTEX_BASE_URL+"/api/site/"+t.id,{pages:r})}).then(function(e){console.log("Page Successfully Configured")}).catch(function(e){console.log("Error: "+e.message)})}),program.command("connect").description("Connect to Vertex 360 site").action(function(){var e=null,n=null,o=null,t=null;if(0==auth.isLoggedIn())return console.log("\nPlease Log In to Connect Site:"),void console.log("$ turbo login\n");auth.connectApp().then(function(e){if(0==e.siteId.length)throw new Error("App Id required");if(0==e.apiKey.length)throw new Error("API Key required");return n=e,auth.currentUser()}).then(function(e){return t=e,utils.getRequest(BASE_URL+"/api/site/"+n.siteId)}).then(function(r){if("success"!=r.confirmation)throw new Error(r.message);if(0==auth.isAuthorized(r.result,t))throw new Error("\nYou must be the admin or a collaborator for this project. To login:\n$ turbo login\n");return o=r.result,e=n,utils.readFile(".env","\n\n.env file not found. Please add .env file.\n\n")}).then(function(n){var t=dotenv.parse(n);t.TURBO_APP_ID=e.siteId,t.TURBO_API_KEY=e.apiKey,t.TURBO_APP_SLUG=o.slug,t.TURBO_CDN="https://cdn.turbo360-vertex.com/"+o.slug+"/public",t.TMP_DIR="/tmp",null==t.SESSION_SECRET&&(t.SESSION_SECRET="YOUR_SESSION_SECRET"),null==t.TURBO_ENV&&(t.TURBO_ENV="dev");var r="";return Object.keys(t).forEach(function(e,n){r+=e+"="+t[e]+"\n"}),utils.write(".env",r),console.log("App credentials successfully configured."),n}).catch(function(e){console.log("Error: "+e.message)})}),program.command("version").description("show current version").action(function(e,n){utils.readFile(path.join(__dirname,"package.json")).then(function(e){var n=JSON.parse(e);console.log("Version "+n.version)}).catch(function(e){console.log("Error: "+e.message)})}),program.command("login").description("login to Turbo 360 account").action(function(e,n){auth.showPrompt().then(function(e){return utils.postRequest(BASE_URL+"/account/login",{email:e.email,password:e.password})}).then(function(e){if("success"!=e.confirmation)throw new Error(e.message);var n={id:e.user._id,username:e.user.username,image:e.user.image,slug:e.user.slug,firstName:e.user.firstName,lastName:e.user.lastName};return shell.cd(""),utils.write(".turbo_user",JSON.stringify(n,null,2)+"\n"),console.log("Logged In As: "+n.username),n}).catch(function(e){console.log("Error: "+e.message)})}),program.command("check-env").description("check env file").action(function(e,n){try{fs.readFileSync(".env","utf8")}catch(e){var o="TURBO_ENV=dev";return o+="\nTURBO_CDN=https://cdn.turbo360-vertex.com",o+="\nSESSION_SECRET=YOUR_SESSION_SECRET",o+="\nTURBO_APP_ID=<TURBO_APP_ID>",o+="\nTMP_DIR=/tmp",o+="\nTURBO_API_KEY=<TURBO_API_KEY>",o+="\nTURBO_APP_SLUG=<TURBO_APP_SLUG>",void utils.write(".env",o)}}),program.command("postinstall").description("npm post install hook").action(function(e,n){try{fs.readFileSync(".env","utf8")}catch(e){var o="TURBO_ENV=dev";return o+="\nTURBO_CDN=https://cdn.turbo360-vertex.com",o+="\nSESSION_SECRET=YOUR_SESSION_SECRET",o+="\nTURBO_APP_ID=<TURBO_APP_ID>",o+="\nTMP_DIR=/tmp",o+="\nTURBO_API_KEY=<TURBO_API_KEY>",o+="\nTURBO_APP_SLUG=<TURBO_APP_SLUG>",void utils.write(".env",o)}}),program.command("themes").description("show available themes").action(function(e,n){utils.readFile("package.json").then(function(e){var n=JSON.parse(e);if("vertex"==n.format){var o=theme.vertexThemes();return console.log("\nTHEMES:\n"+o.join("\n")),void console.log("\nTo install a theme:\n$ turbo theme THEME_NAME\n")}var o=null==n.dependencies.react?theme.staticThemes():theme.reactThemes();console.log("\nTHEMES:\n"+o.join("\n")),console.log("\nTo install a theme:\n$ turbo theme THEME_NAME\n")}).catch(function(e){console.log("Error: "+e.message)})}),program.command("devserver").option("-p, --python","run flask server").description("run development server").action(function(e,n){var o=process.platform,t=e.python?"python":"node";return utils.readFile("package.json","\n\npackage.json file not found. make sure you are in the root directory of the project.\n\n").then(function(e){if("vertex"==JSON.parse(e).format)"win32"==o?shell.exec("node_modules\\.bin\\nodemon node_modules\\vertex360\\www\\vertex_server.js --quiet"):shell.exec("node_modules/.bin/nodemon node_modules/vertex360/www/vertex_server.js --quiet");else{if("python"==t)return void shell.exec("python3 node_modules/turbo360/www/pyserver.py",function(e,n,o){o?console.log("\n* * * * * Please install Flask: $ pip install flask * * * * * \n"):console.log("Program output:",n)});"win32"==o?shell.exec("node_modules\\.bin\\nodemon node_modules\\turbo360\\www\\server.js --quiet"):shell.exec("node_modules/.bin/nodemon node_modules/turbo360/www/server.js --quiet")}}).catch(function(e){console.log("Error: "+e.message)})}),program.command("deploy").option("-d, --dev","deploy to dev").option("-p, --prod","deploy to production").description("deploy app").action(function(e,n){var o=e.prod?"prod":"dev",t=null,r=null,l=null,i=null,s=null,a=null,u=null;if(0==auth.isLoggedIn())return console.log("\nPlease Log In to Deploy:"),void console.log("$ turbo login\n");auth.currentUser().then(function(e){return a=e,utils.readFile("package.json","\n\npackage.json file not found. Make sure you are in the root directory of the project.\n\n")}).then(function(e){return l=JSON.parse(e),u=null==l.format?null==l.dependencies.react?"static":null==l.dependencies.express?"react":"fullstack":l.format,"vertex"==u&&(o="vertex"),utils.readFile(".env","\n\n.env file not found. Please add .env file then run:\n\n$ turbo connect\n\n")}).then(function(e){t=dotenv.parse(e);var n=[{text:"TURBO_CDN",min:20,placeholder:"https://cdn.turbo360-vertex.com"},{text:"TURBO_APP_SLUG",min:6,placeholder:"<TURBO_APP_SLUG>"},{text:"TURBO_API_KEY",min:20,placeholder:"<TURBO_API_KEY>"},{text:"TURBO_APP_ID",min:20,placeholder:"<TURBO_APP_ID>"}];if(null!=utils.validateEnv(t,n))throw new Error("\nEnv mis-configuration. Connect project to Turbo site then try again:\n\n$ turbo connect\n\n");return awsClient.deployConfig({app:t.TURBO_APP_ID,env:o})}).then(function(e){if(void 0==e)throw new Error("Turbo app not found. Please check your APP_ID.");if(r=e.app,0==auth.isAuthorized(r,a))throw new Error("\nYou must be the admin or a collaborator to deploy this project. To login:\n$ turbo login\n");return i=e.deploy,s=e.bucket,awsClient.deleteObject({Bucket:s,Key:r.slug},i)}).then(function(e){if("vertex"==u)return void deploy.deployToVertex(i,s,r);console.log("DEPLOYING TO: "+r.name),"dev"==o?deploy.deployToStaging(i,s,l.deploy,r):deploy.deployToProduction(i,s,l.deploy,r)}).catch(function(e){console.log("ERROR: "+e.message)})}),program.command("customDeploy").description("Deploy to custom environment").action(function(){if(0==auth.awsConfigSet())return console.log("\nPlease Configure AWS Setting:"),void console.log("$ turbo awsConfig\n");var e=null,n=null;auth.awsConfig().then(function(o){return e=o.key+"::"+o.secret,n=o.role,auth.showAWSPrompt()}).then(function(o){if(0==o.bucket.length)throw new Error("Please specify a bucket");if(0==o.folder.length)throw new Error("Please enter a folder");var t=o.bucket.trim(),r=o.folder.trim();console.log(JSON.stringify(o)),deploy.deployToCustom(e,t,{slug:r,role:n})}).catch(function(e){console.log("ERROR: "+e.message)})}),program.command("awsConfig").description("Configure AWS credentials").action(function(){auth.showAWSConfigInputs().then(function(e){if(0==e.awsKey.length)throw new Error("Please enter your AWS key");if(0==e.awsSecret.length)throw new Error("Please enter your AWS secret");if(0==e.awsRole.length)throw new Error("Please enter your AWS role");var n={key:e.awsKey,secret:e.awsSecret,role:e.awsRole};shell.cd(""),utils.write(".turbo_aws_config",JSON.stringify(n,null,2)+"\n"),console.log("AWS Settings Successfully Configured.")}).catch(function(e){console.log("ERROR: "+e.message)})}),program.command("package").description("build package").action(function(e,n){if(0==auth.isLoggedIn())return console.log("\nPlease Log In:"),void console.log("$ turbo login\n");var o=null,t=null,r=null,l=null,i=e.prod?"prod":"dev",s=null,a=null;auth.currentUser().then(function(e){return o=e,utils.readFile(".env")}).then(function(e){t=dotenv.parse(e);var n=t.TURBO_APP_ID;if(null==n)throw new Error('Missing App ID. Please add to .env file under "TURBO_APP_ID" key.');if(n.length<20)throw new Error('Please specify Turbo App ID in the .env file under "TURBO_APP_ID" key.');return utils.readFile("package.json")}).then(function(e){return r=JSON.parse(e),null==r.format?null==r.dependencies.react?format="static":null==r.dependencies.express?format="react":format="fullstack":format=r.format,"vertex"==format&&(i="vertex"),awsClient.deployConfig({app:t.TURBO_APP_ID,env:i})}).then(function(e){if(void 0==e)throw new Error("Turbo app not found. Please check your APP_ID.");return l=e.app,s=e.deploy,a=e.bucket,awsClient.deleteObject({Bucket:a,Key:l.slug},s)}).then(function(e){if("vertex"==format)return void deploy.build(s,a,l)}).catch(function(e){console.log("ERROR: "+e.message)})}),program.command("s3-config").description("Show S3 configuration").action(function(e,n){utils.readFile(path.join(__dirname,"aws/s3-configuration.txt")).then(function(e){console.log(e)}).catch(function(e){console.log("Error: "+e.message)})}),program.parse(process.argv);